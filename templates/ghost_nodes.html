<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ghost Sentinel Hub</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; }
    h1 { margin: 0 0 8px 0; }
    .grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; align-items: start; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; }
    th { background: #fafafa; position: sticky; top: 0; }
    .small { font-size: 12px; color: #666; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    input, select { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; }
    .ok { color: #0a7; border-color: #0a7; }
    .warn { color: #c60; border-color: #c60; }
    #chatLog { height: 340px; overflow: auto; border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fbfbfb; }
    .msg { margin: 0 0 8px 0; }
    .msg .meta { color: #666; font-size: 12px; }
    .msg .text { font-size: 14px; }
  </style>
</head>
<body>
  <h1>Ghost Sentinel Hub</h1>
  <div class="small">Nodes register here when they open Cloudflare tunnels. Now with <b>World Chat</b>.</div>

  <div class="grid" style="margin-top: 14px;">
    <div class="card">
      <h2 style="margin: 0 0 8px 0;">Nodes</h2>
      <div class="small">If your node launcher is running, you should see doors appear here.</div>
      <div style="max-height: 420px; overflow: auto; margin-top: 10px;">
        <table>
          <thead>
            <tr>
              <th>Node</th>
              <th>Service</th>
              <th>Public URL</th>
              <th>Last Seen (UTC)</th>
              <th>Meta</th>
            </tr>
          </thead>
          <tbody>
            {% for n in nodes %}
            <tr>
              <td>{{ n.node }}</td>
              <td>{{ n.service }}</td>
              <td>
                {% if n.url %}
                  <a href="{{ n.url }}" target="_blank" rel="noreferrer">{{ n.url }}</a>
                {% else %}
                  —
                {% endif %}
              </td>
              <td>{{ n.last_seen }}</td>
              <td>{{ n.meta }}</td>
            </tr>
            {% endfor %}
            {% if nodes|length == 0 %}
            <tr><td colspan="5" class="small">No nodes registered yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2 style="margin: 0 0 8px 0;">World Chat</h2>
      <div class="small">Join a room like <span class="pill">#101</span> or create your own.</div>

      <div class="row" style="margin-top: 10px;">
        <input id="userName" placeholder="Name (e.g. Cohen)" style="flex: 1;" />
        <select id="roomSel">
          {% for r in default_rooms %}
            <option value="{{ r }}">{{ r }}</option>
          {% endfor %}
        </select>
        <button id="joinBtn">Join</button>
        <button id="leaveBtn">Leave</button>
      </div>

      <div class="row" style="margin-top: 10px; align-items: center;">
        <span id="status" class="pill warn">disconnected</span>
        <span class="small">Room: <b id="roomLabel">—</b></span>
      </div>

      <div id="chatLog" style="margin-top: 10px;"></div>

      <div class="row" style="margin-top: 10px;">
        <input id="chatMsg" placeholder="Message…" style="flex: 1;" />
        <button id="sendBtn">Send</button>
      </div>
      <div class="small" style="margin-top: 8px;">
        Tip: If you redeploy Render, chat history resets (it’s in-memory).
      </div>
    </div>
  </div>

  <div class="card" style="margin-top: 16px;">
    <h2 style="margin: 0 0 8px 0;">Devices</h2>
    <form method="post" action="/register-device">
      <div class="row">
        <input name="device_name" placeholder="Device name" required />
        <input name="device_type" placeholder="Type (phone, pc, etc.)" />
        <input name="mac" placeholder="MAC address" />
        <input name="api_key" placeholder="API key (optional)" />
        <input name="notes" placeholder="Notes" style="flex: 1;" />
        <button type="submit">Save</button>
      </div>
    </form>

    <div style="max-height: 280px; overflow: auto; margin-top: 10px;">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>MAC</th>
            <th>Created</th>
            <th>Last Seen (UTC)</th>
            <th>Notes</th>
            <th>API Key</th>
          </tr>
        </thead>
        <tbody>
          {% for d in devices %}
          <tr>
            <td>{{ d.name }}</td>
            <td>{{ d.device_type }}</td>
            <td>{{ d.mac }}</td>
            <td>{{ d.created_at }}</td>
            <td>{{ d.last_seen }}</td>
            <td>{{ d.notes }}</td>
            <td>{% if d.api_key_set %}<span class="pill ok">set</span>{% else %}—{% endif %}</td>
          </tr>
          {% endfor %}
          {% if devices|length == 0 %}
          <tr><td colspan="7" class="small">No devices registered yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const roomLabel = document.getElementById("roomLabel");
    const logEl = document.getElementById("chatLog");
    const roomSel = document.getElementById("roomSel");

    let socket = null;
    let currentRoom = null;

    function appendMsg(m) {
      const div = document.createElement("div");
      div.className = "msg";
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `[${m.ts}] ${m.sender} @ ${m.room}`;
      const text = document.createElement("div");
      text.className = "text";
      text.textContent = m.msg;
      div.appendChild(meta);
      div.appendChild(text);
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(ok, text) {
      statusEl.textContent = text;
      statusEl.className = "pill " + (ok ? "ok" : "warn");
    }

    function ensureSocket() {
      if (socket) return;
      socket = io();
      socket.on("connect", () => setStatus(true, "connected"));
      socket.on("disconnect", () => setStatus(false, "disconnected"));
      socket.on("chat_history", (items) => {
        logEl.innerHTML = "";
        (items || []).forEach(appendMsg);
      });
      socket.on("chat_message", (m) => appendMsg(m));
    }

    document.getElementById("joinBtn").addEventListener("click", () => {
      const user = (document.getElementById("userName").value || "guest").trim();
      const room = (roomSel.value || "#101").trim();
      ensureSocket();
      if (currentRoom) socket.emit("leave", {room: currentRoom, user});
      currentRoom = room;
      roomLabel.textContent = room;
      socket.emit("join", {room, user});
    });

    document.getElementById("leaveBtn").addEventListener("click", () => {
      if (!socket || !currentRoom) return;
      const user = (document.getElementById("userName").value || "guest").trim();
      socket.emit("leave", {room: currentRoom, user});
      currentRoom = null;
      roomLabel.textContent = "—";
      logEl.innerHTML = "";
    });

    document.getElementById("sendBtn").addEventListener("click", () => {
      if (!socket || !currentRoom) return;
      const user = (document.getElementById("userName").value || "guest").trim();
      const msgBox = document.getElementById("chatMsg");
      const msg = (msgBox.value || "").trim();
      if (!msg) return;
      socket.emit("send_message", {room: currentRoom, user, msg});
      msgBox.value = "";
      msgBox.focus();
    });

    document.getElementById("chatMsg").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("sendBtn").click();
      }
    });
  </script>
</body>
</html>
